<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mytragor ‚Äî Partida Multiplayer</title>
  <link rel="stylesheet" href="assets/mp/node.css">
  <style>
  :root{ --bg:#0b1220; --panel:#0e1a2b; --line:#2a3b5c; --ink:#e2e8f0; --cardW:75px; --cardH:106px; --hand-scale:.8; --cardW-base:75px; --cardH-base:106px; --scale:1; --left-w:260px; --right-w:240px; --arena-w:1600; --arena-h:900; --radius:8px; --gap:8px; --zoom:1 }
  html,body{height:100%}
  body{margin:0; background-color:#071025; background-image:radial-gradient(1200px 700px at 15% 10%, rgba(255,255,255,0.04), rgba(255,255,255,0) 45%), url("assets/bgambientes/campos_bg.png"), repeating-radial-gradient(circle at 15% 35%, rgba(0,0,0,.03) 0 1px, transparent 1px 12px); background-size:cover,cover,auto; background-position:center center,center center,0 0; background-attachment:fixed,fixed,scroll; color:var(--ink); font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial }
  .app{ display:grid; grid-template-columns: var(--left-w) 1fr var(--right-w); gap:12px; align-items:start; padding:12px; box-sizing:border-box }
  #logCol{ grid-column:1; grid-row:1 / span 2; max-width: var(--left-w); overflow:auto }
  .col.right{ grid-column:2; grid-row:1 / span 2 }
  #previewCol{ grid-column:3; grid-row:1 / span 2; max-width: var(--right-w); overflow:auto }
  .btn{background:#13223a;border:1px solid var(--line);color:#c9d4e7;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:14px;font-weight:500;box-shadow:0 1px 3px rgba(0,0,0,0.2);margin:4px 4px 4px 0;transition:all .2s ease;min-width:80px;text-align:center}
  .btn:hover{transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,.3);opacity:.9}
  .btn-start{background:linear-gradient(135deg,#38bdf8 0%,#0ea5e9 100%);color:#fff;font-weight:600}
  .btn-next{background:linear-gradient(135deg,#f472b6 0%,#be185d 100%);color:#fff;font-weight:600}
  .btn-end{background:linear-gradient(135deg,#f87171 0%,#b91c1c 100%);color:#fff;font-weight:600}
  .log{padding:10px 12px 64px 12px; max-height:36vh; overflow:auto; background: rgba(0,0,0,.75); border-radius: 10px}
  .boardWrap{display:flex;justify-content:center;align-items:center;overflow:auto;padding:4px;flex:1;min-height:0}
  .scaler{ display:flex; align-items:center; justify-content:center; width:100%; height:100%; pointer-events:auto }
  .boardStage{ width: calc(var(--arena-w) * 1px); height: calc(var(--arena-h) * 1px); transform-origin: top left; pointer-events:auto; margin:0 auto; display:block }
  .boardZoom{ transform-origin: 0 0 }
  .board{ padding:6px; margin:0 auto; min-width:640px; max-width:1100px; width:100%; box-sizing:border-box }
  .arena{ position:relative; isolation:isolate; border:1px solid var(--line); border-radius:12px; padding:10px; padding-left: calc(10px + 72px); background:transparent; margin-bottom:12px; box-sizing:border-box; overflow:visible }
  .arenaEnvBg{ position:absolute; inset:0; border-radius:12px; opacity:.08 }
  .sideTitle{ position:relative; z-index:4 }
  .sideTitle.bottom{ position:relative; z-index:4 }
  .fragDock{ position:relative; z-index:4 }
  .aiHand{display:flex;gap:6px;justify-content:center;padding:4px 0}
  .aiBack{width:34px;height:50px;border-radius:5px;border:1px solid #2b3b5c;overflow:hidden;background:#1b2a46}
  .aiBack img{width:100%;height:100%;display:block;object-fit:cover}
  .lane{ display:flex; gap:8px; min-height: 60px }
  .leaderBar{ display:flex; gap:8px; align-items:center }
  .slot{ position:relative; min-width:60px; min-height:60px; border:1px dashed rgba(255,255,255,.06); border-radius:8px; display:flex; align-items:center; justify-content:center }
  .slotLabel{ position:absolute; bottom:4px; left:4px; background:#0f172a; border:1px solid #304566; border-radius:6px; padding:1px 5px; font-size:10px; color:#c9d4e7; z-index:10; pointer-events:none }
  .slotCount{ position:absolute; top:4px; right:4px; background:#0f172a; border:1px solid #304566; border-radius:6px; padding:1px 5px; font-size:10px; color:#c9d4e7; z-index:10; pointer-events:none }
  .hand{display:flex;gap:8px;justify-content:center;padding:10px}
  .phaseBar{display:flex;align-items:center;gap:8px;background:#0e1a2b;border:1px solid #2a3b5c;border-radius:999px;padding:4px 8px;margin:8px auto;font-size:12px;max-width:520px;justify-content:center}
  .phaseItem{display:flex;align-items:center;gap:6px;color:#b7c3da;font-size:12px;opacity:.7}
  .phaseSep{width:22px;height:2px;background:#2a3b5c;opacity:.6;border-radius:2px}
  .inspector{ background: rgba(0,0,0,.5); border-radius:10px; padding:10px }
  </style>
  <link rel="stylesheet" href="assets/mobile.css" media="(max-width:880px)">
</head>
<body>

<div class="topbar">
  <div class="brandWrap">
    <h1 class="brand"><span>Mytragor</span></h1>
    <div class="subtitle">SIMULADOR</div>
  </div>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="btnBackMenu" class="btn gold-btn" onclick="location.href='index.html'">Voltar ao menu</button>
    <button id="btnTutorial" class="btn gold-btn">Tutorial</button>
  </div>
</div>

<div class="app">
  <div class="col" id="logCol">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
      <h3 style="margin:0">Log</h3>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="btnToggleLog" class="panelToggle" aria-expanded="true">‚ñ∏</button>
        <button id="btnToggleLogMobile" class="panelToggle" aria-expanded="false" style="display:none">Abrir</button>
      </div>
    </div>
    <div class="logControls" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;align-items:center;">
      <button class="btn btn-choose" id="btnChoose">Escolher Baralho</button>
      <button class="btn" id="btnRestart" title="Reiniciar">Reiniciar</button>
    </div>
    <div class="log" id="log"></div>
  </div>

  <div class="col right">
    <button id="btnToggleRight" class="panelToggle rightToggle" aria-expanded="true">‚óÇ</button>
    <div class="boardWrap">
      <div class="scaler">
        <div class="boardStage" id="boardStage">
          <div class="board boardZoom">

            <div class="arena" id="opArena">
              <div class="arenaEnvBg" id="opEnvBg" aria-hidden="true"></div>
              <div class="aiHand" id="aiHand"></div>
              <div class="fragDock" id="ai-frags" aria-label="Fragmentos do Oponente"></div>
              <div class="sideTitle">Oponente</div>
              <div class="arenaGrid">
                <div class="mainArea">
                  <div class="lane" id="ai-spells"></div>
                  <div class="lane" id="ai-allies"></div>
                  <div class="leaderBar">
                    <div class="slot" id="ai-leader"></div>
                    <div class="slot" id="ai-env"><span class="slotLabel">Amb</span></div>
                  </div>
                </div>
                <div class="pilesCol">
                  <div class="slot" id="ai-ban"><span class="slotLabel">Banidas</span><span class="slotCount" id="ai-ban-count">0</span></div>
                  <div class="slot" id="ai-grave"><span class="slotLabel">Cemit√©rio</span><span class="slotCount" id="ai-grave-count">0</span></div>
                  <div class="slot" id="ai-deck"><span class="slotLabel">Deck</span><span class="slotCount" id="ai-deck-count">0</span></div>
                </div>
              </div>
            </div>

            

            <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin:8px 0;">
              <span id="whoActive"></span>
              <span id="phasePill"></span>
              <span id="fragPill"></span>
            </div>
            <div class="phaseBar" id="phaseBar" aria-label="Barra de fases" style="display:flex;align-items:center;gap:8px;background:#0e1a2b;border:1px solid #2b3b5c;border-radius:999px;padding:4px 8px;margin:8px auto;font-size:12px;max-width:520px;justify-content:center">
              <div class="phaseItem" data-phase="start"><span class="dot" aria-hidden="true"></span><span>In√≠cio</span></div>
              <div class="phaseSep" aria-hidden="true" style="width:22px;height:2px;background:#2a3b55;opacity:.6;border-radius:2px"></div>
              <div class="phaseItem" data-phase="main"><span class="dot" aria-hidden="true"></span><span>Principal</span></div>
              <div class="phaseSep" aria-hidden="true" style="width:22px;height:2px;background:#2a3b55;opacity:.6;border-radius:2px"></div>
              <div class="phaseItem" data-phase="battle"><span class="dot" aria-hidden="true"></span><span>Combate</span></div>
              <div class="phaseSep" aria-hidden="true" style="width:22px;height:2px;background:#2a3b55;opacity:.6;border-radius:2px"></div>
              <div class="phaseItem" data-phase="end"><span class="dot" aria-hidden="true"></span><span>Final</span></div>
            </div>

            <div style="display:flex;align-items:center;justify-content:center;margin:6px 0 12px 0;">
              <button id="phaseActionBtn" class="btn" style="min-width:160px">Iniciar</button>
            </div>

            <div style="display:flex;align-items:center;justify-content:center;margin:6px 0 12px 0;">
              <div id="mpStatus" style="font-size:13px;color:#94a3b8;">Escolha seu baralho e l√≠der. Aguardando ambos‚Ä¶</div>
            </div>

            <div class="arena" id="youArena">
              <div class="arenaEnvBg" id="youEnvBg" aria-hidden="true"></div>
              <div class="fragDock" id="you-frags" aria-label="Seus Fragmentos"></div>
              <div class="sideTitle bottom">Voc√™</div>
              <div class="arenaGrid">
                <div class="mainArea">
                  <div class="leaderBar">
                    <div class="slot" id="you-leader"></div>
                    <div class="slot" id="you-env"><span class="slotLabel">Amb</span></div>
                  </div>
                  <div class="lane" id="you-allies"></div>
                  <div class="lane" id="you-spells"></div>
                </div>
                <div class="pilesCol">
                  <div class="slot" id="you-ban"><span class="slotLabel">Banidas</span><span class="slotCount" id="you-ban-count">0</span></div>
                  <div class="slot" id="you-grave"><span class="slotLabel">Cemit√©rio</span><span class="slotCount" id="you-grave-count">0</span></div>
                  <div class="slot" id="you-deck"><span class="slotLabel">Deck</span><span class="slotCount" id="you-deck-count">0</span></div>
                </div>
              </div>
              <div class="hand" id="youHand"></div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col" id="previewCol">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:6px">
      <h3 style="margin:0">Pr√©via</h3>
    </div>
    <div class="inspector"><div class="big"><img id="bigImg" src="" alt=""></div></div>
    <div class="meta" id="bigMeta">Passe o mouse sobre uma carta‚Ä¶</div>
  </div>
</div>

<!-- Modal de Sele√ß√£o de Personagem (necess√°rio para chooseLeader/showCharSelect) -->
<div id="charSelect" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;padding:20px;">
  <div style="width:100%;max-width:980px;display:flex;gap:18px;align-items:flex-start;">
    <div style="flex:0 0 320px;background:linear-gradient(180deg,#070709,#0b0b10);border:1px solid rgba(250,204,21,0.08);border-radius:12px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,0.6),0 0 28px rgba(250,190,40,0.03);">
      <button onclick="hideCharSelect()" style="position:absolute;right:34px;top:24px;background:none;border:none;color:#cbd5e1;font-size:22px;cursor:pointer;padding:4px">&times;</button>
      <div style="text-align:center;margin-bottom:12px;color:#facc15;font-weight:800;font-size:18px">Pr√©-visualiza√ß√£o do L√≠der</div>
      <div id="charPreview" style="display:flex;flex-direction:column;align-items:center;gap:10px;color:#e2e8f0">
        <img id="charPreviewImg" src="assets/chosens/valbrak.png" alt="preview" style="width:220px;height:300px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 22px rgba(0,0,0,0.6)" />
        <div id="charPreviewName" style="color:#facc15;font-weight:900"></div>
        <div id="charPreviewStats" style="color:#aab9d3;font-size:13px;text-align:center"></div>
      </div>
    </div>
    <div style="flex:1;background:linear-gradient(180deg,#07121b,#07111a);border:1px solid rgba(255,255,255,0.02);border-radius:12px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.7);">
      <h2 style="margin:0 0 12px 0;color:#facc15;font-size:20px">Escolha seu Escolhido</h2>
      <div id="charGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px;margin-top:8px"></div>
    </div>
  </div>
</div>

<div class="modal" id="pileModal" style="display:none">
  <div class="modalBox">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 id="pileTitle" style="margin:0">‚Äî</h3>
      <button class="btn" onclick="hidePile()">Fechar</button>
    </div>
    <div class="gridMini" id="pileGrid"></div>
  </div>
</div>

<div id="cardChoiceModal" class="modal" style="display:none;align-items:center;justify-content:center;z-index:100">
  <div class="modalBox" style="max-width:800px;width:90vw">
    <h3 id="cardChoiceTitle" style="margin:0 0 16px 0;font-size:18px;color:#e2e8f0;font-weight:bold;text-align:center">Escolha uma carta</h3>
    <div id="cardChoiceGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(48px,1fr));gap:6px;justify-content:center;"></div>
    <button class="btn" id="cardChoiceCancel" style="width:100%">Cancelar</button>
  </div>
</div>

<div id="conversaFiadaModal" class="modal" style="display:none;align-items:center;justify-content:center;z-index:100">
  <div class="modalBox" style="max-width:600px;width:90vw;padding:20px 18px;display:flex;flex-direction:column;align-items:center;">
    <h3 style="margin:0 0 12px 0;font-size:18px;color:#e2e8f0;font-weight:bold;text-align:center">Conversa Fiada</h3>
    <div style="display:flex;gap:14px;align-items:center;width:100%;margin-bottom:12px;">
      <div id="cfTargetPreview" style="display:flex;gap:12px;align-items:center;">
        <img id="cfTargetImg" src="assets/ui/card-back.png" alt="alvo" style="width:64px;height:90px;border-radius:8px;box-shadow:0 4px 18px rgba(0,0,0,0.6);object-fit:cover;" onerror="this.src='assets/ui/card-back.png'">
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div id="cfTargetName" style="font-size:15px;color:#e2e8f0;font-weight:700;">Carta do oponente</div>
          <div id="cfTargetSubtitle" style="font-size:13px;color:#94a3b8;">Voc√™ pode anular esta magia ou truque</div>
        </div>
      </div>
    </div>
    <div style="font-size:14px;color:#e2e8f0;text-align:center;margin-bottom:12px;width:100%;">Ativar <b style="color:#facc15">Conversa Fiada</b> para anular a magia/truque em resposta?</div>
    <div style="font-size:13px;margin-bottom:10px;color:#94a3b8;">Custo: <b style="color:#facc15" id="cfCusto">0</b> fragmento(s).</div>
    <div style="display:flex;gap:12px;justify-content:center;width:100%">
      <button id="btnConversaSim" class="btn" style="flex:1;background:#facc15;color:#1f2937;font-weight:700;">Ativar</button>
      <button id="btnConversaNao" class="btn" style="flex:1;background:#334155;color:#e2e8f0;">Fechar</button>
    </div>
  </div>
</div>

<div id="victoryModal" class="modal" style="display:none;align-items:center;justify-content:center;z-index:200">
  <div class="modalBox" style="max-width:480px;width:90vw;text-align:center;padding:22px;display:flex;flex-direction:column;align-items:center;gap:12px">
    <div style="font-size:48px">üèÜ</div>
    <h2 id="victoryTitle" style="margin:0;font-size:22px;color:#facc15">‚Äî</h2>
    <img id="victoryImg" src="assets/ui/card-back.png" style="width:120px;height:170px;border-radius:10px;object-fit:cover;box-shadow:0 8px 30px rgba(0,0,0,0.6)" onerror="this.src='assets/ui/card-back.png'" />
    <div id="victoryText" style="color:#e2e8f0;font-size:15px;max-width:360px"></div>
    <div style="display:flex;gap:12px;width:100%;justify-content:center;margin-top:6px">
      <button id="victoryBtnClose" class="btn" style="flex:1;background:#334155;color:#e2e8f0;">Fechar</button>
      <button id="victoryBtnReload" class="btn" style="flex:1;background:linear-gradient(135deg,#facc15 0%,#fde68a 100%);color:#7c2d12;font-weight:700;">Jogar de novo</button>
    </div>
  </div>
</div>

<script src="assets/cards/cartas.js?v=2"></script>
<script src="assets/cards/effects.js"></script>
<script src="game/dispatcher.js"></script>
<script src="controllers/HumanController.js"></script>
<script src="client/net/wsClient.js"></script>
<script src="client/multiplayer/syncManager.js"></script>
<script src="client/wrapDispatcherForMP.js"></script>
<script src="assets/mobile.js"></script>
<script src="mp-game.js"></script>
  <script>
;(function(){
  function ready(fn){ if(document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
  function hasBoth(){ try{ return !!(window.STATE && STATE.you && STATE.ai && STATE.you.leader && STATE.ai.leader); }catch(e){ return false; } }
  function bothHaveChosen(){
    try{
      const chosen = window.syncManager.playerChosen; // Usa diretamente do syncManager
      return !!(chosen.p1 && chosen.p2);
    }catch(e){ return false; }
  }
  var startRequested = false;
  var tryStartInterval = null;
  function tryStart(){
    try{
      var el = document.getElementById('mpStatus');
      const chosen = window.syncManager.playerChosen; // Usa diretamente do syncManager
      if(hasBoth() && bothHaveChosen()){
        console.log('[tryStart] GATE PASSED: hasBoth=true, bothHaveChosen=true, playerChosen=', chosen);
        if(!startRequested){
          startRequested = true;
          if(el) el.textContent = 'Ambos escolheram. Iniciando‚Ä¶';
          try{ if(window.syncManager) syncManager.enqueueAndSend('START_MATCH', {}); }catch(e){}
          try{ if(tryStartInterval){ clearInterval(tryStartInterval); tryStartInterval = null; } }catch(e){}
        } else {
          if(el) el.textContent = 'Aguardando in√≠cio da partida‚Ä¶';
        }
        return true;
      } else {
        startRequested = false;
        var you = !!(window.STATE && STATE.you && STATE.you.leader);
        var ai  = !!(window.STATE && STATE.ai && STATE.ai.leader);
        var youChosen = !!(chosen.p1);
        var aiChosen = !!(chosen.p2);
        console.log('[tryStart] GATE FAILED: hasBoth=' + (you && ai) + ', bothHaveChosen=' + (youChosen && aiChosen) + ', playerChosen=', chosen);
        var statusMsg = '';
        if(!youChosen && !aiChosen){ statusMsg = 'Escolha seu baralho e l√≠der. Aguardando ambos‚Ä¶'; }
        else if(youChosen && !aiChosen){ statusMsg = 'Voc√™ escolheu. Aguardando o oponente escolher‚Ä¶'; }
        else if(!youChosen && aiChosen){ statusMsg = 'Oponente escolheu. Aguardando voc√™ escolher‚Ä¶'; }
        else { statusMsg = 'Ambos escolheram. Pronto para iniciar!'; }
        if(el){ el.textContent = statusMsg; }
        return false;
      }
    }catch(e){ console.warn('[mp-game] tryStart error', e); return false; }
  }
  ready(function(){
    try{ if(typeof window.chooseLeader === 'function') window.chooseLeader(); }catch(e){}
    tryStart();
    tryStartInterval = setInterval(tryStart, 500);
  });
  // Wrap deck/leader selection de forma robusta (espera a engine carregar)
  ready(function(){
    function installSelectionWrappers(){
      function sendSetLeaderWhenReady(retries){
        try{
          var r = (typeof retries==='number')?retries:14;
          var leader = (window.STATE && STATE.you && STATE.you.leader) || null;
          var cards  = (window.STATE && STATE.you && STATE.you.customDeck) || null;
          var fragImg= (window.STATE && STATE.you && STATE.you.fragImg) || null;
          if(leader){
            var payload = { side: String(window.localSide||'p1'), leader: leader, cards: cards||null, fragImg: fragImg||null };
            try{ if(window.syncManager && !window.STATE.__leaderSent) {
              syncManager.enqueueAndSend('SET_LEADER', payload);
              window.STATE.__leaderSent = true; // Marca que o l√≠der j√° foi enviado
            }}catch(e){}
          } else if(r>0){ setTimeout(function(){ sendSetLeaderWhenReady(r-1); }, 60); }
        }catch(e){}
      }
      try{
        var origSL = window.selectLeader;
        if(typeof origSL === 'function' && !origSL.__mpWrapped){
          var wrapped = function(){
            try{ origSL.apply(this, arguments); }catch(e){}
            try{ var me = (window.STATE && STATE.you && STATE.you.leader); if(me && typeof window.appendLogLine==='function'){ window.appendLogLine(`Voc√™ escolheu l√≠der: ${me.name||me.key||''}`,'effect'); } }catch(e){}
            if(window.IS_MULTIPLAYER && window.syncManager){ sendSetLeaderWhenReady(14); }
          };
          wrapped.__mpWrapped = true; origSL.__mpWrapped = true; window.selectLeader = wrapped;
        }
      }catch(e){}
      try{
        var origSSD = window.selectSavedDeck;
        if(typeof origSSD === 'function' && !origSSD.__mpWrapped){
          var wrappedDeck = function(deck){
            try{ origSSD.call(this, deck); }catch(e){}
            try{ if(typeof window.appendLogLine==='function'){ window.appendLogLine(`Voc√™ escolheu baralho: ${deck && deck.deckName || ''}`,'effect'); } }catch(e){}
            if(window.IS_MULTIPLAYER && window.syncManager && !window.STATE.__leaderSent){ 
              try{
                var lk = (typeof window.getLeaderKey==='function') ? getLeaderKey(String(deck.leader||'')) : String(deck.leader||'');
                var fallbackLeader = { key: String(lk), name: String(deck.leader||''), img: (window.CHOSEN_IMAGES && CHOSEN_IMAGES[lk]) || deck.leaderImg };
                var payload = { side: String(window.localSide||'p1'), leader: (window.STATE && STATE.you && STATE.you.leader) || fallbackLeader, cards: Array.isArray(deck.cards)? deck.cards.slice() : null, fragImg: deck.fragImg || (window.STATE && STATE.you && STATE.you.fragImg) || null, deckName: deck.deckName||'' };
                syncManager.enqueueAndSend('SET_LEADER', payload);
                window.STATE.__leaderSent = true; // Marca que o l√≠der j√° foi enviado
              }catch(e){}
            }
          };
          wrappedDeck.__mpWrapped = true; origSSD.__mpWrapped = true; window.selectSavedDeck = wrappedDeck;
        }
      }catch(e){}
    }
    installSelectionWrappers();
    window.__mpWrapTO = setInterval(installSelectionWrappers, 200);
  });
  ready(function(){
    try{
      var origAccept = window.syncManager && syncManager.onActionAccepted;
      if(typeof origAccept === 'function'){
        syncManager.onActionAccepted = function(rec){
          try{
            if(rec && rec.actionType === 'SET_LEADER'){
              var mpSide = String(rec.by||rec.playerId||'p1');
              var engineSide = (window.localSide === mpSide) ? 'you' : 'ai';
              var leader = rec.payload && rec.payload.leader;
              var cards = rec.payload && rec.payload.cards;
              var fragImg = rec.payload && rec.payload.fragImg;
              if(window.STATE){
                if(!window.STATE[engineSide]){
                  window.STATE[engineSide] = { allies:[null,null,null,null,null], spells:[null,null,null,null,null], deck:[], hand:[], grave:[], ban:[], customDeck: null };
                }
                if(leader){ 
                  try{ 
                    var L = Object.assign({}, leader);
                    var k = L.key || L.name; 
                    var def = null;
                    if(k && Array.isArray(window.CARD_DEFS)){ def = window.CARD_DEFS.find(d=> (d.key&&d.key===k) || (d.name&&d.name===k)); }
                    if(def){
                      if(!L.filiacao && def.filiacao) L.filiacao = def.filiacao;
                      if(L.ac==null && def.ac!=null) L.ac = def.ac;
                      if(L.hp==null && def.hp!=null) { L.hp = def.hp; L.maxHp = def.maxHp!=null?def.maxHp:def.hp; }
                      if(L.damage==null && def.damage!=null) L.damage = def.damage;
                      if(L.atkBonus==null && def.atkBonus!=null) L.atkBonus = def.atkBonus;
                    }
                    window.STATE[engineSide].leader = { ...L, kind:'leader', img: L.img || (L.key ? (window.CHOSEN_IMAGES && CHOSEN_IMAGES[L.key]) : null) }; 
                  }catch(e){ window.STATE[engineSide].leader = { ...leader, kind:'leader', img: leader.img || (leader.key ? (window.CHOSEN_IMAGES && CHOSEN_IMAGES[leader.key]) : null) }; }
                }
                if(Array.isArray(cards)) window.STATE[engineSide].customDeck = cards.slice();
                if(fragImg) window.STATE[engineSide].fragImg = fragImg;
                try{ if(window.syncManager && typeof syncManager.setContext==='function'){ /* context already set */ } }catch(e){}
                try{ if(window.syncManager && typeof syncManager.persistChoice==='function'){ syncManager.persistChoice(engineSide); } }catch(e){}
                try{ if(window.syncManager && typeof syncManager.getHistory==='function'){ var entry={ t: Date.now(), type:'SET_LEADER(applied)', by: mpSide, side: engineSide, leader: leader }; var h=syncManager.getHistory(); h.push(entry); localStorage.setItem('mp_hist_'+(window.room||window.matchId||'TESTE123'), JSON.stringify(h)); } }catch(e){}
                try{ console.log('[mp-game] apply SET_LEADER', { localSide: window.localSide, mpSide, engineSide, leaderKey: leader && (leader.key||leader.name), hasImg: !!(leader && leader.img) }); }catch(e){}
                try{ renderSide(engineSide); }catch(e){ console.warn('[mp-game] renderSide failed', e); }
                try{ if(typeof updateArenaTheme==='function') updateArenaTheme(); }catch(e){}
                try{ if(typeof updateEnvArenaBackgrounds==='function') updateEnvArenaBackgrounds(); }catch(e){}
                try{ if(typeof renderFrags==='function'){ renderFrags('you'); renderFrags('ai'); } }catch(e){}
                try{ if(window.IS_MULTIPLAYER && window.syncManager && typeof syncManager.persistAll==='function') syncManager.persistAll(); }catch(e){}
                try{ if(typeof window.render==='function') render(); }catch(e){ console.warn('[mp-game] render failed', e); }
                try{
                  var slot = document.querySelector('#'+engineSide+'-leader');
                  var hasChild = !!(slot && slot.children && slot.children.length>0);
                  console.log('[mp-game] leader slot check', { engineSide, hasChild });
                  if(slot && !hasChild && window.STATE[engineSide].leader){ slot.appendChild(cardEl(window.STATE[engineSide].leader,{})); console.log('[mp-game] leader slot appended fallback'); }
                }catch(e){ console.warn('[mp-game] fallback append failed', e); }
                // NOTA: playerChosen j√° √© atualizado no syncManager.applyRemote()
                // N√£o precisamos duplicar essa l√≥gica aqui
                try{
                  console.log('[MP] SET_LEADER accepted, syncManager.playerChosen =', window.syncManager && window.syncManager.playerChosen);
                }catch(e){};
                try{ if(typeof window.appendLogLine==='function'){ var who = (engineSide==='you'?'Voc√™':'Oponente'); var name = (leader&& (leader.name||leader.key)) || ''; appendLogLine(`${who} definiu l√≠der: ${name}`,'effect'); } }catch(e){}
                tryStart();
                // IMPORTANTE: Continuar para chamar origAccept mesmo ap√≥s processar SET_LEADER
                // N√£o fazer return aqui!
              }
            }
          }catch(e){}
          try{ return origAccept(rec); }catch(e){}
        };
      }
    }catch(e){}
  });
})();
  </script>
  <script>
;(function(){
  function ready(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  let currentPlayer = null;

  // Function to randomly select the starting player
  function chooseStartingPlayer() {
    // Do not randomly choose starting player in multiplayer mode; the server/host
    // will determine the starting player via snapshot. If not MP, pick randomly.
    if (window.IS_MULTIPLAYER || window.__IS_MP) {
      console.log('[mp-game] Multiplayer mode - skipping local random starting player');
      return;
    }
    currentPlayer = Math.random() < 0.5 ? 'p1' : 'p2';
    console.log("Starting player (local-only):", currentPlayer);
    const statusElement = document.getElementById('mpStatus');
    if (statusElement) {
      statusElement.textContent = currentPlayer === 'p1' 
        ? 'Jogador 1 foi sorteado para come√ßar!' 
        : 'Jogador 2 foi sorteado para come√ßar!';
    }
  }

  // Function to start the game
  function startGame() {
    // Habilita o bot√£o de a√ß√£o central (renderHUD cuida do texto/handler)
    try{
      console.log(`${currentPlayer} inicia o jogo!`);
      if(typeof renderHUD === 'function') renderHUD();
      var pbtn = document.getElementById('phaseActionBtn'); if(pbtn) pbtn.disabled = false;
    }catch(e){ console.warn('startGame renderHUD failed', e); }
  }

  // Event listeners for buttons
  ready(function() {
    chooseStartingPlayer();
    // Chamamos renderHUD para manter o bot√£o de a√ß√£o (Iniciar/Pr√≥xima Fase/Encerrar Turno)
    // sincronizado com a l√≥gica central definida em `mp-game.js`.
    try{ if(typeof renderHUD === 'function') renderHUD(); }catch(e){}
    // Atualiza periodicamente enquanto a UI √© inicializada (garante sincroniza√ß√£o em MP)
    setInterval(function(){ try{ if(typeof renderHUD === 'function') renderHUD(); }catch(e){} }, 500);
  });
})();
  </script>

  <!-- bot√£o principal de fase movido para ficar entre as arenas -->

</body>
</html>
