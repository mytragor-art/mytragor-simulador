<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>Decks Salvos — Mytragor</title>
	<style>
	body { background: #000000; color: #e2e8f0; font-family: system-ui, sans-serif; margin: 0; }
	.topbar { display: flex; align-items: center; justify-content: space-between; padding: 18px 24px; background: #071025; border-bottom: 1px solid rgba(255,255,255,0.02); }
		.logo { font-size: 22px; font-weight: bold; color: #facc15; letter-spacing: 1px; }
		.deckGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 32px; padding: 32px; }
	.deckCard { background: linear-gradient(180deg, rgba(8,12,20,0.85), rgba(6,8,14,0.9)); border-radius: 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.7); padding: 18px 18px 16px 18px; display: flex; flex-direction: column; align-items: center; position: relative; border: 1px solid rgba(250,200,60,0.04); }
	.deckLeader { width: 80px; height: 112px; border-radius: 10px; box-shadow: 0 4px 18px rgba(250,180,20,0.12); margin-bottom: 10px; object-fit: cover; border: 2px solid #facc15; background: #071025; }
		.deckTitle { font-size: 18px; font-weight: bold; color: #facc15; margin-bottom: 8px; text-align: center; }
		.miniGrid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; margin-bottom: 10px; }
		.miniCard { width: 38px; height: 54px; border-radius: 6px; box-shadow: 0 1px 6px #0006; object-fit: cover; background: #0e1a2b; border: 1px solid #2a3b55; }
		.deckActions { display: flex; gap: 12px; justify-content: center; margin-top: 8px; }
	.btn { background: linear-gradient(180deg,#facc15,#f59e0b); color: #111; border: 1px solid rgba(250,200,60,0.12); border-radius: 8px; padding: 8px 18px; font-size: 15px; font-weight: bold; cursor: pointer; box-shadow: 0 6px 20px rgba(250,180,20,0.06); transition: filter 0.12s, transform 0.12s; }
	.btn:hover { filter: brightness(1.05); transform: translateY(-2px); }
	@media (max-width: 700px) { .deckGrid { grid-template-columns: 1fr; padding: 12px; } }
	</style>
	<link rel="stylesheet" href="../mobile.css" media="(max-width:880px)">
</head>
<body>
	<div class="topbar">
		<span class="logo">Mytragor</span>
		<div style="display:flex;align-items:center;gap:12px">
			<span style="font-size:16px;color:#e2e8f0;">Decks Salvos</span>
			<input id="searchDecks" placeholder="Buscar decks..." style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;width:220px;" />
			<a href="deckbuilder.html" class="btn" style="margin-left:8px;">Montar baralho</a>
		</div>
	</div>
	<div id="deckGrid" class="deckGrid"></div>
	<script src="../cards/cartas.js"></script>
	<script src="../mobile.js"></script>
	<script>
			// Imagens dos líderes
			const CHOSEN_IMAGES = {
				katsu: '../chosens/katsu.png',
				valbrak: '../chosens/valbrak.png',
				leafae: '../chosens/leafae.png',
				ademais: '../chosens/ademais.png'
			};

			// small UI polish: show deck count
			function updateDeckCount(n){
				let el = document.getElementById('deckCount');
				if(!el){ el = document.createElement('div'); el.id='deckCount'; el.style.color='#cbd5e1'; el.style.fontSize='13px'; el.style.marginLeft='12px'; document.querySelector('.topbar').appendChild(el); }
				el.textContent = `${n} decks salvos`;
			}
			// Imagens dos cards
				// Busca imagem pelo nome da carta no CARD_DEFS
				function resolveImg(path) {
					if (!path) return 'card-back.png';
					try {
						if (/^(https?:|data:|file:)/i.test(path)) return path;
						path = String(path).replace(/\\/g, '/').replace(/^\.\//, '').replace(/^\.\.\//, '');
						// If the path points into the assets/ folder, resolve it from project root so we avoid assets/assets
						if (path.startsWith('assets/')) {
							const href = window.location && window.location.href || '';
							const marker = '/assets/ui/';
							const idx = href.indexOf(marker);
							if (idx >= 0) {
								const root = href.slice(0, idx + 1);
								return new URL(path, root).href;
							}
							return new URL(path, window.location.href).href;
						}
						const candidate = (window.location && window.location.pathname || '').includes('/assets/ui/') ? '../' + path : path;
						return new URL(candidate, window.location.href).href;
					} catch (e) { return path; }
				}
				function getCardImg(cardName) {
					if (!window.CARD_DEFS) return 'card-back.png';
					const def = CARD_DEFS.find(c => c.name === cardName);
					return resolveImg(def?.img || 'card-back.png');
				}
		// Encode deck to shareable code
		function encodeDeck(deck) {
			try {
				const deckData = {
					leader: deck.leaderName || deck.leader || '',
					leaderKey: deck.leaderKey || '',
					cards: deck.cards || [],
					fragImg: deck.fragImg || null,
					deckName: deck.deckName || ''
				};
				return 'MTG:' + btoa(JSON.stringify(deckData));
			} catch (e) {
				console.warn('encodeDeck failed', e);
				return '';
			}
		}

		// Carregar decks salvos do localStorage
		function getSavedDecks() {
			const raw = localStorage.getItem('mytragor_decks');
			if (!raw) return [];
			try { return JSON.parse(raw); } catch { return []; }
		}
		function renderDecks() {
			const decks = getSavedDecks();
			const q = (document.getElementById('searchDecks') && document.getElementById('searchDecks').value || '').toLowerCase().trim();
			const filtered = q ? decks.filter(d => ((d.deckName||'') + ' ' + (d.leaderName||d.leader||'')).toLowerCase().includes(q)) : decks;
			const grid = document.getElementById('deckGrid');
			grid.innerHTML = '';
			if (!filtered.length) {
				grid.innerHTML = '<div style="color:#f87171;font-size:18px;text-align:center;padding:40px 0;">Nenhum deck salvo.</div>';
				return;
			}
					filtered.forEach((deck, idx) => {
						const card = document.createElement('div');
						card.className = 'deckCard';
					// Imagem do líder
					let leaderImg = deck.leaderImg || CHOSEN_IMAGES[deck.leaderKey] || 'card-back.png';
					const leader = document.createElement('img');
					leader.className = 'deckLeader';
					leader.src = resolveImg(leaderImg);
					leader.alt = deck.leaderName || 'Líder';
					leader.onerror = () => { leader.src = 'card-back.png'; };
						card.appendChild(leader);
						// Nome do deck/líder
						const title = document.createElement('div');
						title.className = 'deckTitle';
						title.textContent = deck.deckName || deck.leader || deck.leaderName || 'Deck';
						card.appendChild(title);
						
						// Mostrar nome do líder se há um nome personalizado para o deck
						if (deck.deckName) {
							const leaderInfo = document.createElement('div');
							leaderInfo.style.fontSize = '14px';
							leaderInfo.style.color = '#94a3b8';
							leaderInfo.style.marginBottom = '8px';
							leaderInfo.textContent = `Líder: ${deck.leader || deck.leaderName || 'Desconhecido'}`;
							card.appendChild(leaderInfo);
						}
						// Miniaturas das cartas
						const miniGrid = document.createElement('div');
						miniGrid.className = 'miniGrid';
										// Tags do deck (se houver) — exibidas como chips abaixo do título
										if (Array.isArray(deck.tags) && deck.tags.length){
											const tagsWrap = document.createElement('div');
											tagsWrap.style.display = 'flex';
											tagsWrap.style.flexWrap = 'wrap';
											tagsWrap.style.gap = '6px';
											tagsWrap.style.justifyContent = 'center';
											tagsWrap.style.margin = '6px 0 10px 0';
											deck.tags.forEach(t => {
												const chip = document.createElement('span');
												chip.textContent = String(t);
												chip.style.fontSize = '11px';
												chip.style.color = '#cbd5e1';
												chip.style.border = '1px solid rgba(255,255,255,0.06)';
												chip.style.borderRadius = '999px';
												chip.style.padding = '2px 8px';
												chip.style.background = 'rgba(255,255,255,0.03)';
												tagsWrap.appendChild(chip);
											});
											card.appendChild(tagsWrap);
										}
						// show up to 40 cards (4 rows x 10 columns)
						(deck.cards || []).slice(0, 40).forEach(cardName => {
										const mini = document.createElement('img');
										mini.className = 'miniCard';
										let imgSrc = getCardImg(cardName);
										mini.src = imgSrc;
										mini.alt = cardName;
										mini.title = cardName;
										mini.onerror = () => { mini.src = 'card-back.png'; };
										mini.style.cursor = 'pointer';
										mini.onclick = function() {
											showCardModal(imgSrc, cardName);
										};
										miniGrid.appendChild(mini);
						});
						card.appendChild(miniGrid);
						// Botões de ações: Jogar, Copiar, Excluir
						const actions = document.createElement('div');
						actions.className = 'deckActions';
						const btnPlay = document.createElement('button'); btnPlay.className='btn'; btnPlay.textContent='Jogar';
						btnPlay.onclick = function(){
							try{ localStorage.setItem('mytragor_play_deck', JSON.stringify({ deckName: deck.deckName||'', leader: deck.leaderName||deck.leader||'', leaderImg: deck.leaderImg||null, cards: deck.cards||[], fragImg: deck.fragImg||null })); }catch(e){}
							window.open('../../mytragor_simulador.html','_blank');
						};
					const btnCopy = document.createElement('button'); btnCopy.className='btn'; btnCopy.textContent='Copiar lista';
					btnCopy.onclick = function(){
						navigator.clipboard && navigator.clipboard.writeText((deck.cards||[]).join('\n'));
						alert('Lista de cartas copiada para a área de transferência.');
					};
					const btnExport = document.createElement('button'); btnExport.className='btn'; btnExport.textContent='Copiar código';
					btnExport.onclick = function(){
						const deckCode = encodeDeck(deck);
						navigator.clipboard && navigator.clipboard.writeText(deckCode);
						alert('Código do deck copiado! Cole no montador para importar.');
					};
						const btnDel = document.createElement('button'); btnDel.className='btn'; btnDel.textContent='Excluir';
						btnDel.onclick = function () {
							if (confirm('Excluir este deck salvo?')) {
								const all = getSavedDecks();
								// find the actual index in storage (filtered may change ordering)
								const realIdx = all.findIndex(x=> (x.deckName===deck.deckName && x.leader===deck.leader) || (x.leaderName===deck.leaderName && x.deckName===deck.deckName));
								if(realIdx>=0) { all.splice(realIdx,1); localStorage.setItem('mytragor_decks', JSON.stringify(all)); }
								renderDecks(); updateDeckCount(all.length);
							}
						};
						actions.appendChild(btnPlay); actions.appendChild(btnCopy); actions.appendChild(btnExport); actions.appendChild(btnDel);
						card.appendChild(actions);
						grid.appendChild(card);
					});
					updateDeckCount(filtered.length);

					// Modal para exibir carta ampliada
					function showCardModal(imgSrc, cardName) {
						let modal = document.getElementById('cardModal');
						if (!modal) {
							modal = document.createElement('div');
							modal.id = 'cardModal';
							modal.style.position = 'fixed';
							modal.style.top = '0';
							modal.style.left = '0';
							modal.style.width = '100vw';
							modal.style.height = '100vh';
							modal.style.background = 'rgba(0,0,0,0.8)';
							modal.style.display = 'flex';
							modal.style.alignItems = 'center';
							modal.style.justifyContent = 'center';
							modal.style.zIndex = '9999';
							modal.onclick = function() { modal.remove(); };
							document.body.appendChild(modal);
						} else {
							modal.innerHTML = '';
							modal.style.display = 'flex';
						}
						const img = document.createElement('img');
						img.src = imgSrc;
						img.alt = cardName;
						img.style.maxWidth = '90vw';
						img.style.maxHeight = '90vh';
						img.style.borderRadius = '16px';
						img.style.boxShadow = '0 4px 32px #000a';
						modal.appendChild(img);
					}
		}
			renderDecks();
			// wire search
			const search = document.getElementById('searchDecks');
			if(search) search.addEventListener('input', ()=>{ renderDecks(); });
	</script>
</body>
</html>